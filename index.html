<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hava Durumu Simülasyonu — Gelişmiş</title>
  <style>
    /* =========================================================
       Tema ve reset
       ========================================================= */
    :root{
      --bg-day-top:#78c3f7;
      --bg-day-bottom:#e6f4ff;
      --bg-night-top:#071a33;
      --bg-night-bottom:#0d2747;
      --card:#ffffff;
      --card-night:#0e1d33;
      --text:#1e293b;
      --text-night:#e6edf3;
      --muted:#667085;
      --muted-night:#95a3b8;
      --accent:#0ea5e9;
      --accent-2:#22d3ee;
      --ok:#2e7d32;
      --warn:#f59e0b;
      --err:#ef4444;
      --border:#e2e8f0;
      --border-night:#18314f;
      --shadow:rgba(0,0,0,0.12);
    }
    *{box-sizing:border-box}
    html,body{margin:0; padding:0; min-height:100vh}
    body{
      font-family:Inter, Segoe UI, Arial, sans-serif;
      color:var(--text);
      background:linear-gradient(to bottom, var(--bg-day-top), var(--bg-day-bottom));
    }
    body.night{
      color:var(--text-night);
      background:linear-gradient(to bottom, var(--bg-night-top), var(--bg-night-bottom));
    }
    .container{max-width:1200px; margin:0 auto; padding:18px}
    h1{margin:0 0 8px; font-size:32px}
    .subtitle{margin:4px 0 16px; color:var(--muted)}
    body.night .subtitle{color:var(--muted-night)}
    .grid{display:grid; grid-template-columns:420px 1fr; gap:16px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:0 8px 24px var(--shadow);
      overflow:hidden;
    }
    body.night .card{
      background:var(--card-night);
      border-color:var(--border-night);
      box-shadow:0 8px 24px rgba(0,0,0,0.35);
    }
    .card-header{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      font-weight:700;
    }
    body.night .card-header{border-color:var(--border-night)}
    .card-content{padding:14px}

    /* =========================================================
       Banner (hatırlatıcı)
       ========================================================= */
    .banner{
      display:none; align-items:center; gap:10px;
      background:#fff8e1; color:#6a4e06;
      border:1px solid #fde68a; border-radius:10px; padding:10px 12px;
      margin-bottom:10px;
    }
    body.night .banner{
      background:#362b0e; color:#f7e3ad; border-color:#6b5a2a;
    }
    .banner.show{display:flex}
    .banner .badge{
      background:#f59e0b; color:#fff; font-weight:700; font-size:12px;
      padding:2px 8px; border-radius:999px;
    }
    .banner button{margin-left:auto}

    /* =========================================================
       Buton ve girişler
       ========================================================= */
    button{
      border:none; border-radius:10px;
      padding:10px 12px; cursor:pointer; font-weight:600; color:#fff;
      background:var(--accent);
      transition:transform .08s ease, filter .2s ease;
    }
    button:hover{filter:brightness(1.05)}
    button:active{transform:scale(0.98)}
    .btn-secondary{background:#475569}
    .btn-ghost{
      background:transparent; color:inherit; border:1px solid var(--border);
    }
    body.night .btn-ghost{border-color:var(--border-night)}
    .btn-ok{background:var(--ok)}
    .btn-warn{background:var(--warn)}
    .btn-err{background:var(--err)}
    input, select{
      width:100%; padding:10px; border-radius:10px; border:1px solid var(--border);
      background:#fff; color:var(--text);
    }
    body.night input, body.night select{
      background:#12243c; color:var(--text-night); border-color:var(--border-night);
    }
    label{font-size:12px; color:var(--muted)}
    body.night label{color:var(--muted-night)}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{padding:8px 12px; border-radius:999px; background:#eef6ff; color:#0b4f7c; font-size:13px}
    body.night .pill{background:#132236; color:#9fd3ff}
    .divider{height:1px; background:var(--border); margin:12px 0}
    body.night .divider{background:var(--border-night)}

    /* =========================================================
       İstatistik kutuları
       ========================================================= */
    .stat{display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:10px}
    @media (max-width:980px){ .stat{grid-template-columns:1fr 1fr} }
    .stat-item{
      background:#f7fafc; border:1px solid var(--border);
      border-radius:10px; padding:10px; text-align:center;
    }
    body.night .stat-item{background:#0c1a2b; border-color:var(--border-night)}
    .stat-title{font-size:12px; color:var(--muted)}
    body.night .stat-title{color:var(--muted-night)}
    .stat-value{font-size:20px; font-weight:700; margin-top:6px}

    /* =========================================================
       Hava kutusu ve sahne
       ========================================================= */
    .weather-wrap{
      display:grid; grid-template-columns:380px 1fr; gap:16px; align-items:stretch;
    }
    @media (max-width:980px){ .weather-wrap{grid-template-columns:1fr} }

    .weather-box{
      border-radius:12px; border:1px solid var(--border);
      background:#ffffff; padding:12px; box-shadow:0 8px 24px var(--shadow);
    }
    body.night .weather-box{background:#102034; border-color:var(--border-night)}
    .weather-line{display:flex; justify-content:space-between; margin:8px 0}
    .weather-line .label{color:var(--muted); font-size:13px}
    body.night .weather-line .label{color:var(--muted-night)}
    .weather-line .value{font-weight:700}

    .scene{
      position:relative; min-height:320px; border-radius:12px; border:1px solid var(--border);
      background:linear-gradient(to top,#bfe6ff, #eaf6ff); overflow:hidden;
    }
    body.night .scene{background:linear-gradient(to top,#06162b,#0c203a); border-color:var(--border-night)}

    /* =========================================================
       Güneş, ay, bulut
       ========================================================= */
    .sun{
      position:absolute; width:100px; height:100px; border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #fff68a, #ffd54f, #fbc02d);
      box-shadow:0 0 35px rgba(255,213,79,0.65), 0 0 90px rgba(255,213,79,0.25);
      top:22px; left:22px; animation:spin 24s linear infinite;
    }
    @keyframes spin{from{transform:rotate(0)} to{transform:rotate(360deg)}}
    .moon{
      position:absolute; width:78px; height:78px; border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #fff, #cdd7e1);
      box-shadow:0 0 26px rgba(255,255,255,0.55);
      top:22px; right:22px; animation:drift 18s ease-in-out infinite;
    }
    @keyframes drift{0%{transform:translateY(0)} 50%{transform:translateY(8px)} 100%{transform:translateY(0)}}

    .cloud{
      position:absolute; width:150px; height:60px; border-radius:30px; background:#fff;
      box-shadow:16px 0 0 #fff, -16px 0 0 #fff, 0 12px 0 #fff, 26px 8px 0 #fff, -26px 8px 0 #fff;
      filter:drop-shadow(0 6px 6px rgba(0,0,0,0.06));
      animation:float 12s ease-in-out infinite;
    }
    @keyframes float{0%{transform:translateX(-12px)} 50%{transform:translateX(12px)} 100%{transform:translateX(-12px)}}
    .cloud.dark{
      background:#dee7ef; box-shadow:16px 0 0 #dee7ef, -16px 0 0 #dee7ef, 0 12px 0 #dee7ef, 26px 8px 0 #dee7ef, -26px 8px 0 #dee7ef;
    }

    /* Rüzgâr görseli: çizgiler */
    .wind-streak{
      position:absolute; height:2px; background:linear-gradient(to right, rgba(255,255,255,0), rgba(255,255,255,0.8), rgba(255,255,255,0));
      animation:windmove 2.2s linear infinite;
      opacity:0.75;
    }
    @keyframes windmove{
      0%{transform:translateX(-160px)}
      100%{transform:translateX(160px)}
    }

    /* Yağmur / kar / dolu */
    .raindrop{
      position:absolute; width:2px; height:22px; border-radius:2px;
      background:linear-gradient(to bottom,#6ec1ff,#2a8bd6);
      animation:rain 1.0s linear infinite; opacity:0.9;
    }
    @keyframes rain{0%{transform:translateY(-24px); opacity:0} 10%{opacity:1} 100%{transform:translateY(280px); opacity:0}}
    .snowflake{
      position:absolute; width:10px; height:10px; border-radius:50%;
      background:radial-gradient(circle,#fff,#e9f2ff); box-shadow:0 0 6px rgba(255,255,255,0.7);
      animation:snow 3.0s ease-in-out infinite;
    }
    @keyframes snow{0%{transform:translateY(-24px) translateX(0); opacity:0} 10%{opacity:1} 50%{transform:translateY(160px) translateX(12px)} 100%{transform:translateY(300px) translateX(-12px); opacity:0}}
    .hail{
      position:absolute; width:6px; height:6px; border-radius:50%; background:#e8f1ff; box-shadow:0 0 4px rgba(255,255,255,0.7);
      animation:hail 1.3s linear infinite;
    }
    @keyframes hail{0%{transform:translateY(-24px); opacity:0} 10%{opacity:1} 100%{transform:translateY(280px); opacity:0}}
    .fog-layer{
      position:absolute; left:0; right:0; bottom:0; height:140px;
      background:linear-gradient(to top, rgba(255,255,255,0.7), rgba(255,255,255,0.0));
      filter:blur(2px); animation:fog 6s ease-in-out infinite;
    }
    body.night .fog-layer{background:linear-gradient(to top, rgba(230,235,245,0.55), rgba(230,235,245,0.0))}
    @keyframes fog{0%{transform:translateX(-16px)} 50%{transform:translateX(16px)} 100%{transform:translateX(-16px)}}

    /* Yıldırım (Lightning) */
    .lightning{
      position:absolute; left:0; right:0; top:0; bottom:0;
      background:radial-gradient(circle at 60% 20%, rgba(255,255,255,0.9), rgba(255,255,255,0.0) 40%);
      mix-blend-mode:screen; opacity:0; animation:flicker .9s ease-out forwards;
    }
    @keyframes flicker{0%{opacity:0} 10%{opacity:1} 25%{opacity:0.3} 40%{opacity:0.8} 60%{opacity:0.1} 100%{opacity:0}}

    /* =========================================================
       Mini grafik ve takvim
       ========================================================= */
    .mini-wrap{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:980px){ .mini-wrap{grid-template-columns:1fr} }
    .canvas-box{
      border:1px solid var(--border); border-radius:12px; overflow:hidden;
      background:#ffffff;
    }
    body.night .canvas-box{background:#102034; border-color:var(--border-night)}
    .canvas-header{padding:8px 10px; font-weight:700; border-bottom:1px solid var(--border)}
    body.night .canvas-header{border-color:var(--border-night)}
    .canvas-content{padding:8px}
    canvas{width:100%; height:220px; background:transparent}

    .calendar{
      display:grid; grid-template-columns:repeat(5, 1fr); gap:8px;
    }
    .cal-cell{
      border:1px solid var(--border); border-radius:12px; padding:8px; min-height:60px;
      display:flex; flex-direction:column; gap:4px; background:#ffffff;
    }
    body.night .cal-cell{background:#0f1b2a; border-color:var(--border-night)}
    .cal-day{font-size:12px; color:var(--muted)}
    body.night .cal-day{color:var(--muted-night)}
    .cal-cond{font-size:12px; font-weight:700}
    .cal-temp{font-size:12px}

    /* =========================================================
       Modal
       ========================================================= */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,0.35);
      display:none; align-items:center; justify-content:center; z-index:999;
    }
    .modal{
      width:580px; max-width:92vw; background:#ffffff; color:var(--text);
      border-radius:12px; padding:16px; box-shadow:0 16px 48px rgba(0,0,0,0.3);
      border:1px solid var(--border);
    }
    body.night .modal{background:#102034; color:var(--text-night); border-color:var(--border-night)}
    .modal.show{display:flex}
    .modal-header{font-weight:700; font-size:18px; margin-bottom:8px}
    .modal-actions{display:flex; justify-content:flex-end; gap:8px; margin-top:12px}
    .error{color:var(--err); font-size:12px; min-height:14px}

    /* =========================================================
       Hız slider
       ========================================================= */
    .slider-wrap{display:flex; align-items:center; gap:12px}
    .slider-wrap input[type="range"]{width:220px}

  </style>
</head>
<body>
  <div class="container">
    <h1>Hava Durumu Simülasyonu</h1>
    <p class="subtitle">Her 10 günde bir blok tahmini gir. Sıcaklık aralığı: -30–45 °C. Durum listesi Türkçe. Rüzgâr, yağış, yıldırım ve mini grafiklerle zenginleşir.</p>

    <!-- Hatırlatıcı banner -->
    <div id="banner" class="banner">
      <span class="badge">Uyarı</span>
      <span id="bannerText">Bu blok için tahmin girilmedi.</span>
      <button id="bannerAction" class="btn-warn">Tahmin Gir</button>
    </div>

    <div class="grid">
      <!-- Sol panel -->
      <div class="card">
        <div class="card-header">Zaman ve Kontroller</div>
        <div class="card-content">
          <div class="row">
            <div class="pill" id="pillDay">Gün: 1</div>
            <div class="pill" id="pillBlock">Blok: 1–10</div>
            <div class="pill" id="pillMode">Mod: Gündüz</div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <button id="btnPrev">Önceki</button>
            <button id="btnNext">Sonraki</button>
            <button id="btnPlay" class="btn-ok">Başlat</button>
            <button id="btnPause" class="btn-err">Dur</button>
            <button id="btnJump" class="btn-secondary">Güne Git</button>
            <button id="btnToggleNight" class="btn-ghost">Gece/Gündüz</button>
          </div>

          <div style="height:8px"></div>

          <div class="slider-wrap">
            <label>Hız (ms/gün)</label>
            <input id="speedRange" type="range" min="200" max="3000" step="100" value="1200"/>
            <span id="speedValue">1200</span>
          </div>

          <div class="divider"></div>

          <div class="stat">
            <div class="stat-item">
              <div class="stat-title">Toplam gün</div>
              <div class="stat-value" id="statDays">1</div>
            </div>
            <div class="stat-item">
              <div class="stat-title">Blok sayısı</div>
              <div class="stat-value" id="statBlocks">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-title">Son durum</div>
              <div class="stat-value" id="statCond">-</div>
            </div>
            <div class="stat-item">
              <div class="stat-title">Son sıcaklık</div>
              <div class="stat-value" id="statTemp">-</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <button id="btnNewForecast">Tahmin Gir (10 Gün)</button>
            <button id="btnEditBlock" class="btn-secondary">Bloku Düzenle</button>
            <button id="btnExport" class="btn-ghost">Dışa Aktar</button>
            <button id="btnImport" class="btn-ghost">İçe Aktar</button>
            <button id="btnClear" class="btn-err">Temizle</button>
          </div>
        </div>
      </div>

      <!-- Sağ panel -->
      <div class="card">
        <div class="card-header">Hava ve Sahne</div>
        <div class="card-content">
          <div class="weather-wrap">
            <div>
              <div class="weather-box">
                <div class="weather-line"><div class="label">Gün</div><div class="value" id="outDay">1</div></div>
                <div class="weather-line"><div class="label">Blok</div><div class="value" id="outBlock">1–10</div></div>
                <div class="weather-line"><div class="label">Durum</div><div class="value" id="outCond">-</div></div>
                <div class="weather-line"><div class="label">En Düşük</div><div class="value" id="outMin">- °C</div></div>
                <div class="weather-line"><div class="label">En Yüksek</div><div class="value" id="outMax">- °C</div></div>
                <div class="weather-line"><div class="label">Günlük Tahmini</div><div class="value" id="outDaily">- °C</div></div>
              </div>

              <div style="height:8px"></div>

              <div class="mini-wrap">
                <div class="canvas-box">
                  <div class="canvas-header">Mini Sıcaklık Grafiği (Blok)</div>
                  <div class="canvas-content"><canvas id="miniChart"></canvas></div>
                </div>
                <div class="canvas-box">
                  <div class="canvas-header">Takvim Görünümü (10 Gün)</div>
                  <div class="canvas-content">
                    <div class="calendar" id="calendar"></div>
                  </div>
                </div>
              </div>
            </div>

            <div id="scene" class="scene">
              <!-- Dinamik sahne öğeleri JS ile eklenecek -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>
    <div class="card">
      <div class="card-header">Blok Bazlı Doğrulama Raporu</div>
      <div class="card-content" id="report">
        <!-- Rapor satırları JS ile eklenecek -->
      </div>
    </div>
  </div>

  <!-- Modal: Tahmin Girişi -->
  <div id="forecastModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">10 Günlük Tahmin Gir</div>
      <div class="row">
        <div class="pill" id="modalBlockLabel">Blok: 1–10</div>
      </div>
      <div style="height:8px"></div>
      <div class="row" style="gap:12px; flex-wrap:nowrap">
        <div style="flex:1">
          <label>En Düşük Sıcaklık (°C) -30 ile 45</label>
          <input id="minInput" type="number" min="-30" max="45" step="1" placeholder="-30 ile 45">
          <div class="error" id="minError"></div>
        </div>
        <div style="flex:1">
          <label>En Yüksek Sıcaklık (°C) -30 ile 45</label>
          <input id="maxInput" type="number" min="-30" max="45" step="1" placeholder="-30 ile 45">
          <div class="error" id="maxError"></div>
        </div>
      </div>

      <div style="height:8px"></div>

      <div>
        <label>Hava Durumu</label>
        <select id="condSelect">
          <option value="">Seçin...</option>
          <option>güneşli</option>
          <option>az bulutlu</option>
          <option>parçalı bulutlu</option>
          <option>çok bulutlu</option>
          <option>hafif sağanak yağmur</option>
          <option>sağanak yağmur</option>
          <option>kuvvetli sağanak yağmur</option>
          <option>yağmur</option>
          <option>dolu</option>
          <option>sis</option>
          <option>hafif kar yağışlı</option>
          <option>kar yağışlı</option>
          <option>yoğun kar yağışlı</option>
        </select>
        <div class="error" id="condError"></div>
      </div>

      <div class="modal-actions">
        <button id="modalCancel" class="btn-secondary">İptal</button>
        <button id="modalSave" class="btn-ok">Kaydet</button>
      </div>
    </div>
  </div>

  <!-- Modal: İçe Aktar -->
  <div id="importModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">JSON İçe Aktar</div>
      <div class="subtitle">Geçerli JSON veri yapısını yapıştırın.</div>
      <textarea id="importArea" rows="8" style="width:100%; border-radius:10px; padding:10px; border:1px solid var(--border)"></textarea>
      <div class="error" id="importError"></div>
      <div class="modal-actions">
        <button id="importCancel" class="btn-secondary">İptal</button>
        <button id="importApply" class="btn-ok">Uygula</button>
      </div>
    </div>
  </div>

  <script>
    /* =========================================================
       Durum listesi ve state
       ========================================================= */
    const CONDITIONS = [
      "güneşli",
      "az bulutlu",
      "parçalı bulutlu",
      "çok bulutlu",
      "hafif sağanak yağmur",
      "sağanak yağmur",
      "kuvvetli sağanak yağmur",
      "yağmur",
      "dolu",
      "sis",
      "hafif kar yağışlı",
      "kar yağışlı",
      "yoğun kar yağışlı"
    ];

    const UI = {
      banner: document.getElementById('banner'),
      bannerText: document.getElementById('bannerText'),
      bannerAction: document.getElementById('bannerAction'),

      pillDay: document.getElementById('pillDay'),
      pillBlock: document.getElementById('pillBlock'),
      pillMode: document.getElementById('pillMode'),

      outDay: document.getElementById('outDay'),
      outBlock: document.getElementById('outBlock'),
      outCond: document.getElementById('outCond'),
      outMin: document.getElementById('outMin'),
      outMax: document.getElementById('outMax'),
      outDaily: document.getElementById('outDaily'),

      statDays: document.getElementById('statDays'),
      statBlocks: document.getElementById('statBlocks'),
      statCond: document.getElementById('statCond'),
      statTemp: document.getElementById('statTemp'),

      speedRange: document.getElementById('speedRange'),
      speedValue: document.getElementById('speedValue'),

      scene: document.getElementById('scene'),
      miniChart: document.getElementById('miniChart'),
      calendar: document.getElementById('calendar'),
      report: document.getElementById('report')
    };

    const BTN = {
      prev: document.getElementById('btnPrev'),
      next: document.getElementById('btnNext'),
      play: document.getElementById('btnPlay'),
      pause: document.getElementById('btnPause'),
      jump: document.getElementById('btnJump'),
      toggleNight: document.getElementById('btnToggleNight'),
      newForecast: document.getElementById('btnNewForecast'),
      editBlock: document.getElementById('btnEditBlock'),
      exportBtn: document.getElementById('btnExport'),
      importBtn: document.getElementById('btnImport'),
      clear: document.getElementById('btnClear')
    };

    const MODAL_FORECAST = {
      root: document.getElementById('forecastModal'),
      blockLabel: document.getElementById('modalBlockLabel'),
      minInput: document.getElementById('minInput'),
      maxInput: document.getElementById('maxInput'),
      condSelect: document.getElementById('condSelect'),
      minError: document.getElementById('minError'),
      maxError: document.getElementById('maxError'),
      condError: document.getElementById('condError'),
      cancel: document.getElementById('modalCancel'),
      save: document.getElementById('modalSave')
    };

    const MODAL_IMPORT = {
      root: document.getElementById('importModal'),
      area: document.getElementById('importArea'),
      error: document.getElementById('importError'),
      cancel: document.getElementById('importCancel'),
      apply: document.getElementById('importApply')
    };

    let state = {
      day: 1,
      isPlaying: false,
      speedMs: 1200,
      nightMode: false,
      // forecasts: array of { blockStart, blockEnd, min, max, cond }
      forecasts: [],
      // derived per-day temps cache: { [blockStart]: number[] } length 10
      blockDailyTemps: {},
      // wind strength 0..3 per condition
      wind: 0
    };

    /* =========================================================
       Kaydet / Yükle
       ========================================================= */
    function save(){
      try{
        localStorage.setItem('weather-sim-adv', JSON.stringify(state));
      }catch(e){}
    }
    function load(){
      const raw = localStorage.getItem('weather-sim-adv');
      if(!raw) return;
      try{
        const obj = JSON.parse(raw);
        if(obj && typeof obj==='object'){
          state = Object.assign(state, obj);
        }
      }catch(e){}
    }

    /* =========================================================
       Yardımcılar
       ========================================================= */
    function getBlockRange(day){
      const start = Math.floor((day-1)/10)*10+1;
      return {start, end:start+9};
    }
    function getBlockIndex(day){
      const {start} = getBlockRange(day);
      return (day - start);
    }
    function findForecast(blockStart, blockEnd){
      return state.forecasts.find(f=>f.blockStart===blockStart && f.blockEnd===blockEnd) || null;
    }
    function findForecastForDay(day){
      const {start,end} = getBlockRange(day);
      return findForecast(start,end);
    }
    function upsertForecast(blockStart, blockEnd, min, max, cond){
      const idx = state.forecasts.findIndex(f=>f.blockStart===blockStart && f.blockEnd===blockEnd);
      const payload = {blockStart, blockEnd, min, max, cond};
      if(idx>=0) state.forecasts[idx] = payload; else state.forecasts.push(payload);
      // Daily temps recalc
      state.blockDailyTemps[blockStart] = interpolateBlock(min, max);
      save();
      updateUI();
      renderCalendar(blockStart);
      renderReport();
    }

    /* =========================================================
       Interpolasyon: 10 günlük blok için günlük sıcaklıklar
       - Basit lineer min→max (gündüz tepe), küçük sin varyasyonu
       ========================================================= */
    function interpolateBlock(min, max){
      const days = 10;
      const arr = [];
      const range = max - min;
      for(let i=0;i<days;i++){
        const t = i/(days-1); // 0..1
        // lineer trend: min -> max
        let base = min + range * t;
        // diurnal küçük dalgalanma: sin eğrisi
        const wave = Math.sin((i/ days)*Math.PI) * (range*0.1);
        // random hafif gürültü
        const noise = (Math.random()-0.5) * 1.2;
        arr.push(Math.round((base + wave + noise)*10)/10);
      }
      return arr;
    }

    /* =========================================================
       Mini Grafik (Canvas): blok sıcaklıkları
       ========================================================= */
    function drawMiniChart(blockStart){
      const canvas = UI.miniChart;
      const ctx = canvas.getContext('2d');
      const w = canvas.width = canvas.clientWidth;
      const h = canvas.height = 220;

      ctx.clearRect(0,0,w,h);

      const temps = state.blockDailyTemps[blockStart];
      if(!temps || temps.length!==10){
        ctx.fillStyle = '#94a3b8';
        ctx.font = '14px Inter';
        ctx.fillText('Grafik verisi yok', 12, 20);
        return;
      }
      const minVal = Math.min(...temps);
      const maxVal = Math.max(...temps);

      // eksenler
      ctx.strokeStyle = '#cbd5e1';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(30, h-30); ctx.lineTo(w-10, h-30); // x eksen
      ctx.moveTo(30, 20); ctx.lineTo(30, h-30); // y eksen
      ctx.stroke();

      // grid
      ctx.strokeStyle = '#e2e8f0';
      for(let gy=0; gy<4; gy++){
        const y = 20 + gy*((h-50)/3);
        ctx.beginPath();
        ctx.moveTo(30, y); ctx.lineTo(w-10, y);
        ctx.stroke();
      }

      // Min/Max etiket
      ctx.fillStyle = '#475569';
      ctx.font = '12px Inter';
      ctx.fillText(`Min: ${minVal} °C`, w-120, 24);
      ctx.fillText(`Max: ${maxVal} °C`, w-120, 42);

      // çizgi
      const xStep = (w-50)/9;
      ctx.lineWidth = 2.2;
      ctx.strokeStyle = '#0ea5e9';
      ctx.beginPath();
      for(let i=0;i<temps.length;i++){
        const x = 30 + i * xStep;
        // scale Y: minVal..maxVal => 20..(h-30)
        const y = map(temps[i], minVal, maxVal, h-30, 20);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();

      // noktalar
      ctx.fillStyle = '#22d3ee';
      for(let i=0;i<temps.length;i++){
        const x = 30 + i * xStep;
        const y = map(temps[i], minVal, maxVal, h-30, 20);
        ctx.beginPath(); ctx.arc(x,y,3.5,0,Math.PI*2); ctx.fill();
      }

      // gün etiketleri
      ctx.fillStyle = '#64748b';
      ctx.font = '11px Inter';
      for(let i=0;i<10;i++){
        const x = 30 + i * xStep;
        ctx.fillText(String(i+1), x-4, h-12);
      }
    }
    function map(v, inMin, inMax, outMin, outMax){
      if(inMax===inMin) return (outMin+outMax)/2;
      const t = (v-inMin)/(inMax-inMin);
      return outMin + t*(outMax-outMin);
    }

    /* =========================================================
       Takvim görünümü (10 hücre)
       ========================================================= */
    function renderCalendar(blockStart){
      const {end} = {start:blockStart, end:blockStart+9};
      UI.calendar.innerHTML = '';
      const fc = findForecast(blockStart, end);
      const temps = state.blockDailyTemps[blockStart];
      for(let i=0;i<10;i++){
        const cell = document.createElement('div');
        cell.className = 'cal-cell';
        const d = document.createElement('div'); d.className='cal-day'; d.textContent = `Gün ${i+1}`;
        const c = document.createElement('div'); c.className='cal-cond'; c.textContent = fc?fc.cond:'-';
        const t = document.createElement('div'); t.className='cal-temp'; t.textContent = temps?`${temps[i]} °C`:'- °C';
        cell.append(d,c,t);
        UI.calendar.appendChild(cell);
      }
    }

    /* =========================================================
       Rapor: blok bazlı doğrulama
       ========================================================= */
    function renderReport(){
      UI.report.innerHTML='';
      if(state.forecasts.length===0){
        UI.report.textContent='Henüz kayıtlı blok yok.';
        return;
      }
      for(const fc of state.forecasts){
        const row = document.createElement('div');
        row.style.borderBottom = '1px dashed var(--border)';
        row.style.padding = '8px 0';

        const title = document.createElement('div');
        title.style.fontWeight='700';
        title.textContent = `Blok ${fc.blockStart}–${fc.blockEnd} — ${fc.cond}, ${fc.min}–${fc.max} °C`;
        row.appendChild(title);

        const issues = [];
        if(fc.min<-30 || fc.min>45) issues.push('En düşük sıcaklık sınır dışında.');
        if(fc.max<-30 || fc.max>45) issues.push('En yüksek sıcaklık sınır dışında.');
        if(fc.min>fc.max) issues.push('En düşük, en yüksekten büyük olamaz.');
        if(!CONDITIONS.includes(fc.cond)) issues.push('Geçersiz hava durumu.');

        if(issues.length===0){
          const ok = document.createElement('div');
          ok.style.color='var(--ok)';
          ok.textContent='Doğrulama: OK';
          row.appendChild(ok);
        } else {
          const ul = document.createElement('ul');
          ul.style.color='var(--err)';
          for(const it of issues){
            const li = document.createElement('li');
            li.textContent = it;
            ul.appendChild(li);
          }
          row.appendChild(ul);
        }
        UI.report.appendChild(row);
      }
    }

    /* =========================================================
       Sahne: temizle ve duruma göre çiz
       Rüzgâr gücü, yağış, dolu, sis, yıldırım çakması
       WebAudio ile gök gürültüsü
       ========================================================= */
    function clearScene(){ UI.scene.innerHTML=''; }

    function drawSun(){ const el=document.createElement('div'); el.className='sun'; UI.scene.appendChild(el); }
    function drawMoon(){ const el=document.createElement('div'); el.className='moon'; UI.scene.appendChild(el); }
    function drawClouds(level=1){
      const count = level===1?2: level===2?3:4;
      for(let i=0;i<count;i++){
        const c = document.createElement('div');
        c.className='cloud'+(level>=3?' dark':'');
        c.style.top = (40 + i*30) + 'px';
        c.style.left = (40 + i*140) + 'px';
        // rüzgâr hızına göre animation-duration
        const dur = (state.wind===0?12 : state.wind===1?9 : state.wind===2?6 : 4);
        c.style.animationDuration = dur + 's';
        UI.scene.appendChild(c);
      }
    }
    function drawRain(intensity=2){
      const drops = intensity===1?60:intensity===2?110:160;
      for(let i=0;i<drops;i++){
        const d = document.createElement('div');
        d.className='raindrop';
        d.style.left = (Math.random()* (UI.scene.clientWidth-20)) + 'px';
        d.style.top = (50 + Math.random()*60) + 'px';
        d.style.animationDelay = (Math.random()*0.8)+'s';
        UI.scene.appendChild(d);
      }
      drawClouds(intensity>=2?3:2);
    }
    function drawSnow(intensity=2){
      const flakes = intensity===1?60:intensity===2?110:160;
      for(let i=0;i<flakes;i++){
        const s = document.createElement('div');
        s.className='snowflake';
        s.style.left = (Math.random()* (UI.scene.clientWidth-20)) + 'px';
        s.style.top = (40 + Math.random()*60) + 'px';
        s.style.animationDelay = (Math.random()*1.2)+'s';
        UI.scene.appendChild(s);
      }
      drawClouds(intensity>=2?2:1);
    }
    function drawHail(intensity=2){
      const balls = intensity===1?80:intensity===2?130:180;
      for(let i=0;i<balls;i++){
        const h = document.createElement('div');
        h.className='hail';
        h.style.left = (Math.random()* (UI.scene.clientWidth-20)) + 'px';
        h.style.top = (40 + Math.random()*60) + 'px';
        h.style.animationDelay = (Math.random()*0.8)+'s';
        UI.scene.appendChild(h);
      }
      drawClouds(intensity>=2?3:2);
    }
    function drawFog(){
      drawClouds(2);
      const f = document.createElement('div');
      f.className='fog-layer';
      UI.scene.appendChild(f);
    }
    function drawWindStreaks(level=1){
      const rows = level===1?3: level===2?5:7;
      for(let i=0;i<rows;i++){
        const w = document.createElement('div');
        w.className='wind-streak';
        w.style.top = (80 + i*24) + 'px';
        w.style.left = '10px';
        w.style.width = (UI.scene.clientWidth-20) + 'px';
        w.style.animationDuration = (2.2 - 0.4*state.wind) + 's';
        UI.scene.appendChild(w);
      }
    }

    // Yıldırım + gürültü
    function flashLightning(){
      const l = document.createElement('div');
      l.className='lightning';
      UI.scene.appendChild(l);
      setTimeout(()=> l.remove(), 900);
      thunder();
    }
    // WebAudio thunder (basit noise + lowpass)
    let audioCtx = null;
    function thunder(){
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const bufferSize = 2 * audioCtx.sampleRate;
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for(let i=0;i<bufferSize;i++){
          // Perlin yok; basit brownian-ish noise
          data[i] = (Math.random()*2-1) * (1 - i/bufferSize);
        }
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 300;
        const gain = audioCtx.createGain();
        gain.gain.value = 0.6;
        source.connect(filter).connect(gain).connect(audioCtx.destination);
        source.start();
        setTimeout(()=> source.stop(), 1400);
      }catch(e){}
    }

    /* =========================================================
       Duruma göre sahneyi çiz
       Rüzgâr gücü: 0..3
       ========================================================= */
    function renderByCondition(cond){
      clearScene();
      const c = (cond||'').toLowerCase();

      // gece/gündüz görselleri
      if(state.nightMode) drawMoon(); else drawSun();

      // rüzgâr gücü (örnek belirleme)
      if(c.includes('kuvvetli') || c.includes('sağanak')) state.wind = 3;
      else if(c.includes('yağmur') || c.includes('çok bulutlu')) state.wind = 2;
      else if(c.includes('bulutlu') || c.includes('sis')) state.wind = 1;
      else state.wind = 0;

      // rüzgâr çizgileri
      if(state.wind>0) drawWindStreaks(state.wind);

      // durumlara göre sahne
      if (c==='güneşli'){
        // sadece güneş + ince bulutlar
        drawClouds(1);
      } else if (c==='az bulutlu'){
        drawClouds(1);
      } else if (c==='parçalı bulutlu'){
        drawClouds(2);
      } else if (c==='çok bulutlu'){
        drawClouds(3);
      } else if (c==='hafif sağanak yağmur'){
        drawRain(1);
      } else if (c==='sağanak yağmur'){
        drawRain(2);
        if(Math.random()<0.4) flashLightning();
      } else if (c==='kuvvetli sağanak yağmur'){
        drawRain(3);
        if(Math.random()<0.7) flashLightning();
      } else if (c==='yağmur'){
        drawRain(2);
      } else if (c==='dolu'){
        drawHail(2);
        if(Math.random()<0.5) flashLightning();
      } else if (c==='sis'){
        drawFog();
      } else if (c==='hafif kar yağışlı'){
        drawSnow(1);
      } else if (c==='kar yağışlı'){
        drawSnow(2);
      } else if (c==='yoğun kar yağışlı'){
        drawSnow(3);
      } else {
        drawClouds(1);
      }
    }

    /* =========================================================
       Gece/gündüz modu
       ========================================================= */
    function applyNightMode(){
      document.body.classList.toggle('night', state.nightMode);
      UI.pillMode.textContent = 'Mod: ' + (state.nightMode?'Gece':'Gündüz');
    }

    /* =========================================================
       Banner kontrolü
       ========================================================= */
    function updateBanner(){
      const {start,end} = getBlockRange(state.day);
      const fc = findForecast(start,end);
      if(!fc){
        UI.banner.classList.add('show');
        UI.bannerText.textContent = `Blok ${start}–${end} için tahmin girilmedi.`;
        UI.bannerAction.onclick = ()=> openForecastModal(start,end);
      }else{
        UI.banner.classList.remove('show');
      }
    }

    /* =========================================================
       UI güncelle
       ========================================================= */
    function updateUI(){
      const {start,end} = getBlockRange(state.day);
      const idx = getBlockIndex(state.day);
      const fc = findForecast(start,end);

      UI.pillDay.textContent = `Gün: ${state.day}`;
      UI.pillBlock.textContent = `Blok: ${start}–${end}`;

      UI.outDay.textContent = state.day;
      UI.outBlock.textContent = `${start}–${end}`;
      if(fc){
        UI.outCond.textContent = fc.cond;
        UI.outMin.textContent = `${fc.min} °C`;
        UI.outMax.textContent = `${fc.max} °C`;
        // Daily temp from interpolation
        const arr = state.blockDailyTemps[start] || interpolateBlock(fc.min, fc.max);
        state.blockDailyTemps[start] = arr;
        const daily = arr[idx];
        UI.outDaily.textContent = `${daily} °C`;
        UI.statCond.textContent = fc.cond;
        UI.statTemp.textContent = `${fc.min}–${fc.max} °C`;
        renderByCondition(fc.cond);
        drawMiniChart(start);
        renderCalendar(start);
      } else {
        UI.outCond.textContent = '-';
        UI.outMin.textContent = '- °C';
        UI.outMax.textContent = '- °C';
        UI.outDaily.textContent = '- °C';
        UI.statCond.textContent = '-';
        UI.statTemp.textContent = '-';
        clearScene();
        // çizim temizlenmişken yine de mini chart ve calendar boş göster
        UI.miniChart.getContext('2d').clearRect(0,0,UI.miniChart.width,UI.miniChart.height);
        UI.calendar.innerHTML='';
      }

      applyNightMode();
      updateBanner();
      UI.statDays.textContent = state.day;
      UI.statBlocks.textContent = state.forecasts.length;
      save();
    }

    /* =========================================================
       Simülasyon kontrolü
       ========================================================= */
    let timer = null;
    function stepDay(forward=true){
      state.day = Math.max(1, forward? state.day+1 : state.day-1);
      const {start} = getBlockRange(state.day);
      if(!findForecastForDay(state.day)){
        // Blok başında değilse bile reminder
        const isStart = (state.day===start);
        if(isStart) openForecastModal(start, start+9);
      }
      updateUI();
    }
    function play(){
      if(state.isPlaying) return;
      state.isPlaying = true;
      timer = setInterval(()=> stepDay(true), state.speedMs);
    }
    function pause(){
      state.isPlaying = false;
      if(timer){ clearInterval(timer); timer=null; }
    }

    /* =========================================================
       Modal: Tahmin Girişi
       ========================================================= */
    function openForecastModal(start,end){
      MODAL_FORECAST.blockLabel.textContent = `Blok: ${start}–${end}`;
      MODAL_FORECAST.root.dataset.blockStart = start;
      MODAL_FORECAST.root.dataset.blockEnd = end;
      MODAL_FORECAST.minInput.value = '';
      MODAL_FORECAST.maxInput.value = '';
      MODAL_FORECAST.condSelect.value = '';
      MODAL_FORECAST.minError.textContent = '';
      MODAL_FORECAST.maxError.textContent = '';
      MODAL_FORECAST.condError.textContent = '';
      MODAL_FORECAST.root.classList.add('show');
      MODAL_FORECAST.root.style.display='flex';

      // Düzenleme ise mevcut doldur
      const fc = findForecast(start,end);
      if(fc){
        MODAL_FORECAST.minInput.value = fc.min;
        MODAL_FORECAST.maxInput.value = fc.max;
        MODAL_FORECAST.condSelect.value = fc.cond;
      }
    }
    function closeForecastModal(){
      MODAL_FORECAST.root.classList.remove('show');
      MODAL_FORECAST.root.style.display='none';
    }
    function validateForecastInputs(minVal, maxVal, cond){
      let ok=true;
      MODAL_FORECAST.minError.textContent='';
      MODAL_FORECAST.maxError.textContent='';
      MODAL_FORECAST.condError.textContent='';
      if(isNaN(minVal) || minVal<-30 || minVal>45){ MODAL_FORECAST.minError.textContent='-30 ile 45 arasında olmalı'; ok=false; }
      if(isNaN(maxVal) || maxVal<-30 || maxVal>45){ MODAL_FORECAST.maxError.textContent='-30 ile 45 arasında olmalı'; ok=false; }
      if(ok && minVal>maxVal){ MODAL_FORECAST.maxError.textContent='En yüksek, en düşükten büyük olmalı'; ok=false; }
      if(!cond || !CONDITIONS.includes(cond)){ MODAL_FORECAST.condError.textContent='Geçerli bir durum seçin'; ok=false; }
      return ok;
    }

    /* =========================================================
       İçe/Dışa Aktar
       ========================================================= */
    function openImportModal(){
      MODAL_IMPORT.error.textContent='';
      MODAL_IMPORT.area.value='';
      MODAL_IMPORT.root.classList.add('show');
      MODAL_IMPORT.root.style.display='flex';
    }
    function closeImportModal(){
      MODAL_IMPORT.root.classList.remove('show');
      MODAL_IMPORT.root.style.display='none';
    }

    /* =========================================================
       Olay bağlama
       ========================================================= */
    BTN.prev.addEventListener('click', ()=> stepDay(false));
    BTN.next.addEventListener('click', ()=> stepDay(true));
    BTN.play.addEventListener('click', ()=> play());
    BTN.pause.addEventListener('click', ()=> pause());
    BTN.jump.addEventListener('click', ()=>{
      const v = prompt('Gün numarası (1 ve üzeri):');
      if(v===null) return;
      const n = parseInt(v,10);
      if(isNaN(n) || n<1){ alert('Geçersiz gün değeri'); return; }
      state.day = n; updateUI();
      const {start,end} = getBlockRange(state.day);
      if(!findForecast(start,end)) openForecastModal(start,end);
    });
    BTN.toggleNight.addEventListener('click', ()=>{
      state.nightMode = !state.nightMode;
      updateUI();
    });
    BTN.newForecast.addEventListener('click', ()=>{
      const {start,end} = getBlockRange(state.day);
      openForecastModal(start,end);
    });
    BTN.editBlock.addEventListener('click', ()=>{
      const {start,end} = getBlockRange(state.day);
      openForecastModal(start,end);
    });
    BTN.exportBtn.addEventListener('click', ()=>{
      const json = JSON.stringify(state, null, 2);
      navigator.clipboard.writeText(json).then(()=> alert('JSON panoya kopyalandı')).catch(()=> alert('Kopyalama başarısız'));
    });
    BTN.importBtn.addEventListener('click', ()=> openImportModal());
    BTN.clear.addEventListener('click', ()=>{
      if(!confirm('Tüm verileri silmek istiyor musunuz?')) return;
      pause();
      state = { day:1, isPlaying:false, speedMs: UI.speedRange.valueAsNumber || 1200, nightMode:false, forecasts:[], blockDailyTemps:{}, wind:0 };
      save(); updateUI();
    });

    UI.speedRange.addEventListener('input', ()=>{
      state.speedMs = UI.speedRange.valueAsNumber;
      UI.speedValue.textContent = String(state.speedMs);
      if(state.isPlaying){ pause(); play(); }
    });

    MODAL_FORECAST.cancel.addEventListener('click', ()=> closeForecastModal());
    MODAL_FORECAST.save.addEventListener('click', ()=>{
      const start = parseInt(MODAL_FORECAST.root.dataset.blockStart,10);
      const end = parseInt(MODAL_FORECAST.root.dataset.blockEnd,10);
      const minVal = parseInt(MODAL_FORECAST.minInput.value,10);
      const maxVal = parseInt(MODAL_FORECAST.maxInput.value,10);
      const cond = MODAL_FORECAST.condSelect.value;

      if(!validateForecastInputs(minVal, maxVal, cond)) return;
      upsertForecast(start, end, minVal, maxVal, cond);
      closeForecastModal();
      updateUI();
    });

    MODAL_IMPORT.cancel.addEventListener('click', ()=> closeImportModal());
    MODAL_IMPORT.apply.addEventListener('click', ()=>{
      MODAL_IMPORT.error.textContent='';
      let txt = MODAL_IMPORT.area.value;
      if(!txt || !txt.trim()){ MODAL_IMPORT.error.textContent='Boş içerik'; return; }
      try{
        const obj = JSON.parse(txt);
        if(!obj || typeof obj!=='object'){ MODAL_IMPORT.error.textContent='Geçersiz JSON'; return; }
        if(!('day' in obj) || !('forecasts' in obj)){ MODAL_IMPORT.error.textContent='Eksik alanlar'; return; }
        pause();
        state = Object.assign(state, obj);
        save(); closeImportModal(); updateUI();
      }catch(e){
        MODAL_IMPORT.error.textContent='JSON parse hatası';
      }
    });

    UI.bannerAction.addEventListener('click', ()=>{
      const {start,end} = getBlockRange(state.day);
      openForecastModal(start,end);
    });

    /* =========================================================
       Başlatma
       ========================================================= */
    function init(){
      load();
      UI.speedRange.value = state.speedMs;
      UI.speedValue.textContent = String(state.speedMs);
      updateUI();
      window.addEventListener('resize', ()=> updateUI());
    }
    init();
  </script>
</body>
</html>
